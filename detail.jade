doctype html
html
  head
    title Welcome
    
    script(src='js/vendor/jquery-2.1.1.min.js')
    script(src='js/vendor/prismic.io-1.0.28.min.js')
    script(src='js/prismic-configuration.js')
    script(src='js/prismic-helpers.js')
    script(src='js/prismic-templates.js')
    
  body.loading

    header
      script(type='text/template')
        a(href!="index.html?<%= ctx.maybeRefParam %>")
          h1 Your prismic.io project

    article
        script(type='text/template')
          | <%= doc.asHtml(ctx) %>
            
        

    aside
      script(type='text/template')
        | <% if(doc.linkedDocuments.length > 0) { %>
        hr
        h2 Linked documents:
        ul
          | <% for(var i=0; i<doc.linkedDocuments.length; i++) { %>
          li
            a(href!="detail.html?id=<%= doc.linkedDocuments[i].id %>&slug=<%= doc.linkedDocuments[i].slug %>")
              | <%= doc.linkedDocuments[i].slug %>
          | <% } %>
        | <% } %>

    footer
      script(type='text/template')
        | <% if(!ctx.oauth().hasPrivilegedAccess) { %>
        hr
        a(href="signin.html") Sign in to preview changes
        | <% } %>


    script(src="//static.cdn.prismic.io/prismic.js")

    script.
      $(function() {

        Helpers.withPrismic(function(ctx) {

          // Retrieve the document
          var id = Helpers.queryString['id'],
              slug = Helpers.queryString['slug'];

          ctx.api.form("everything").ref(ctx.ref).query('[[:d = at(document.id, "' + id + '")]]').submit(function(err, docs) {

            if (err) { Configuration.onPrismicError(err); return; }

            var doc = docs.results[0];

            // If there is no documents for this id
            if(!doc) {
              document.location = 'notfound.html';
            }

            // If the slug doesn't match
            if(doc.slug != slug) {
              // If this is an old valid slug, redirect
              if(doc.slugs.indexOf(slug) > -1) {
                document.location = 'detail.html?id=' + doc.id + '&slug=' + doc.slug + '&ref=' + ref;
              } else {
                document.location = 'notfound.html';
              }
            }

            // Feed the templates
            $('header, article, aside, footer').render({
              doc: doc,
              ctx: ctx
            });

          });

        });

      });
        

